{% extends "base.html" %}
{% block title %}{{ circle.name }}{% endblock %}

{% block nav %}
<nav class="nav" style="padding:8px 12px;">
    <div class="nav-inner">
        <a href="/dashboard" class="nav-brand" style="font-size:0.9rem;">
            <span>üéØ</span> {{ circle.name }}
        </a>
        <div class="nav-links">
            <a href="/settings" class="btn btn-ghost btn-sm" style="padding:4px 8px;">‚öôÔ∏è</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block body %}
<div style="max-width:360px; margin:0 auto; padding:12px;">

    <!-- Availability Toggle -->
    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm); margin-bottom:12px;" id="availCard">
        <div>
            <div style="font-weight:700; font-size:0.9rem;" id="availLabel">Loading...</div>
            <div class="text-xs text-muted" id="availSub"></div>
        </div>
        <button class="toggle-btn" id="availToggle" onclick="toggleAvailability()"></button>
    </div>

    <!-- Current / Next Call (compact) -->
    <div id="nextCallSection" style="display:none; margin-bottom:12px;">
        <div class="text-xs text-muted" style="margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Current Call</div>
        <div id="nextCallCard" style="padding:10px 14px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm);"></div>
    </div>

    <!-- Who's Available -->
    <div style="margin-bottom:12px;">
        <div class="text-xs text-muted" style="margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
            Team <span id="availCount"></span>
        </div>
        <div id="memberList"></div>
    </div>

    <!-- Compact Actions -->
    <div style="display:flex; gap:8px;">
        <button onclick="openLogSession()" class="btn btn-secondary btn-sm" style="flex:1; font-size:0.8rem;">üéØ Log Session</button>
        <button onclick="copyInvite()" class="btn btn-secondary btn-sm" style="flex:1; font-size:0.8rem;">üîó Invite</button>
    </div>

    <!-- Expandable sections -->
    <details style="margin-top:12px;">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">üìä Stats & Leaderboard</summary>
        <div style="padding-top:8px;">
            <div class="stats-grid" id="statsGrid" style="grid-template-columns: repeat(2, 1fr); gap:8px;"></div>
            <div id="leaderboard" style="margin-top:8px;"></div>
        </div>
    </details>

    <details style="margin-top:8px;">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">üìÖ Full Calendar</summary>
        <div id="calendarEvents" style="padding-top:8px;"></div>
    </details>

    <details style="margin-top:8px;">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">üìã Recent Sessions</summary>
        <div id="recentSessions" style="padding-top:8px;"></div>
    </details>
</div>

<!-- Log Session Modal -->
<div class="modal-overlay" id="sessionModal">
    <div class="modal" style="max-width:340px; padding:20px;">
        <div class="modal-title" style="font-size:0.9rem;">üéØ Log Session</div>
        <div class="form-group">
            <label class="form-label">Partner</label>
            <select id="sessionPartner" class="form-input">
                <option value="">Select...</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Duration</label>
            <select id="sessionDuration" class="form-input">
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="15" selected>15 min</option>
                <option value="20">20 min</option>
                <option value="30">30 min</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Rating</label>
            <div class="flex gap-1" id="ratingStars">
                <button onclick="setRating(1)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(2)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(3)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(4)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(5)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
            </div>
        </div>
        <div class="flex gap-1">
            <button onclick="submitSession()" class="btn btn-green btn-sm" id="logSessionBtn">Log</button>
            <button onclick="closeModal('sessionModal')" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const CIRCLE_CODE = '{{ code }}';
const MY_ID = {{ user.id }};
let isAvailable = false;
let members = [];
let sessionRating = 0;

// ============ STATUS ============
async function loadStatus() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/status`);
        members = data.members;
        isAvailable = data.my_available;

        const toggle = document.getElementById('availToggle');
        const label = document.getElementById('availLabel');
        const sub = document.getElementById('availSub');

        toggle.classList.toggle('active', isAvailable);
        label.textContent = isAvailable ? "You're Available üü¢" : "You're Unavailable";
        sub.textContent = `${data.available_count} of ${data.members.length} free`;

        if (data.group_session_ready && isAvailable) {
            sub.textContent += ' ‚Äî Go! üéØ';
        }

        document.getElementById('availCount').textContent = `(${data.available_count}/${data.members.length})`;

        renderMembers(data.members);
    } catch (err) {
        console.error('Failed to load status:', err);
    }
}

function renderMembers(members) {
    const list = document.getElementById('memberList');
    if (!members.length) {
        list.innerHTML = '<div class="text-sm text-muted" style="padding:12px;">No members yet</div>';
        return;
    }

    // Sort: available first, then alphabetical
    const sorted = [...members].sort((a, b) => {
        if (a.available !== b.available) return b.available - a.available;
        return a.name.localeCompare(b.name);
    });

    list.innerHTML = sorted.map(m => {
        const dotClass = m.available ? 'online' : 'offline';
        const border = m.available ? 'border-color:var(--green);' : '';
        const bg = m.available ? 'background:var(--green-dim);' : '';

        let action = '';
        if (m.available && !m.is_me && m.zoom_link) {
            action = `<a href="${m.zoom_link}" target="_blank" class="btn btn-green btn-sm" style="padding:3px 10px; font-size:0.75rem;">Join</a>`;
        }

        return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm); margin-bottom:4px; ${border}${bg}">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="status-dot ${dotClass}"></span>
                    <span style="font-size:0.85rem; font-weight:600;">${m.name}${m.is_me ? ' (you)' : ''}</span>
                </div>
                ${action}
            </div>
        `;
    }).join('');
}

// ============ NEXT CALL ============
async function loadNextCall() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/calendar`);
        const section = document.getElementById('nextCallSection');
        const card = document.getElementById('nextCallCard');

        if (!data.events || !data.events.length) {
            section.style.display = 'none';
            return;
        }

        // Show the first event (current or next)
        const e = data.events[0];
        section.style.display = 'block';

        let noshowBtn = '';
        if (e.needs_noshow_prompt) {
            noshowBtn = `<button onclick="markNoShow('${e.uid}', '${e.summary.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" style="padding:3px 10px; font-size:0.75rem; margin-top:6px;">No-show? Go available</button>`;
        }

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <div style="font-weight:600; font-size:0.85rem;">${e.summary}</div>
                    <div class="text-xs text-muted">${e.start_time} ‚Äì ${e.end_time}${e.calendar ? ' ¬∑ ' + e.calendar : ''}</div>
                    ${noshowBtn}
                </div>
            </div>
        `;
    } catch (err) {
        document.getElementById('nextCallSection').style.display = 'none';
    }
}

// ============ AVAILABILITY ============
async function toggleAvailability() {
    isAvailable = !isAvailable;
    try {
        await api(`/api/circle/${CIRCLE_CODE}/available`, {
            method: 'POST',
            body: { available: isAvailable }
        });
        loadStatus();
        if (isAvailable) showToast("You're available! üéØ");
    } catch (err) {
        showToast(err.message, 'error');
        isAvailable = !isAvailable;
    }
}

// ============ NO SHOW ============
async function markNoShow(uid, summary) {
    try {
        await api(`/api/circle/${CIRCLE_CODE}/noshow`, {
            method: 'POST',
            body: { event_uid: uid, event_summary: summary }
        });
        showToast("No-show! You're available üéØ");
        loadStatus();
        loadNextCall();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ FULL CALENDAR (expandable) ============
async function loadCalendar() {
    const container = document.getElementById('calendarEvents');
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/calendar`);
        if (!data.events || !data.events.length) {
            container.innerHTML = '<div class="text-sm text-muted">No more events today</div>';
            return;
        }
        container.innerHTML = data.events.map(e => `
            <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.8rem;">
                <span class="text-muted" style="min-width:55px;">${e.start_time}</span>
                <span style="flex:1;">${e.summary}</span>
                ${e.needs_noshow_prompt ? `<button onclick="markNoShow('${e.uid}', '${e.summary.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" style="padding:2px 8px;font-size:0.7rem;">No-show</button>` : ''}
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div class="text-sm text-muted">Could not load calendar</div>';
    }
}

// ============ STATS (expandable) ============
async function loadStats() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/stats`);
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_sessions_this_week}</div>
                <div class="stat-label">This Week</div>
            </div>
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_total_sessions}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_streak}üî•</div>
                <div class="stat-label">Streak</div>
            </div>
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_noshows}</div>
                <div class="stat-label">No-Shows</div>
            </div>
        `;

        const lb = document.getElementById('leaderboard');
        if (data.leaderboard.length) {
            lb.innerHTML = data.leaderboard.map((p, i) => `
                <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.8rem;">
                    <span style="width:20px; text-align:center; font-weight:700;">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#'+(i+1)}</span>
                    <span style="flex:1; font-weight:${p.is_me ? '700' : '400'}; ${p.is_me ? 'color:var(--accent);' : ''}">${p.name}</span>
                    <span style="font-weight:700;">${p.sessions}</span>
                </div>
            `).join('');
        } else {
            lb.innerHTML = '<div class="text-sm text-muted">No sessions yet</div>';
        }
    } catch (err) {
        console.error(err);
    }
}

async function loadRecentSessions() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/recent-sessions`);
        const container = document.getElementById('recentSessions');
        if (!data.sessions.length) {
            container.innerHTML = '<div class="text-sm text-muted">No sessions yet</div>';
            return;
        }
        container.innerHTML = data.sessions.map(s => `
            <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.8rem;">
                <span>${s.user1_name} ‚Üî ${s.user2_name} ¬∑ ${s.duration_minutes}min</span>
                <span class="text-muted">${timeAgo(s.created_at)}</span>
            </div>
        `).join('');
    } catch (err) {
        console.error(err);
    }
}

// ============ INVITE ============
let inviteUrl = '';
async function loadInvite() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/invite`);
        inviteUrl = data.invite_url;
    } catch (err) {}
}

function copyInvite() {
    if (inviteUrl) {
        copyToClipboard(inviteUrl);
    } else {
        showToast('Loading invite...', 'error');
        loadInvite();
    }
}

// ============ LOG SESSION ============
function openLogSession() {
    const select = document.getElementById('sessionPartner');
    select.innerHTML = '<option value="">Select...</option>';
    members.filter(m => !m.is_me).forEach(m => {
        select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
    });
    sessionRating = 0;
    updateRatingStars();
    document.getElementById('sessionModal').classList.add('active');
}

function setRating(n) {
    sessionRating = n;
    updateRatingStars();
}

function updateRatingStars() {
    document.querySelectorAll('.rating-star').forEach((btn, i) => {
        btn.style.opacity = i < sessionRating ? '1' : '0.3';
    });
}

async function submitSession() {
    const partnerId = document.getElementById('sessionPartner').value;
    const duration = parseInt(document.getElementById('sessionDuration').value);
    if (!partnerId) return showToast('Select a partner', 'error');

    const btn = document.getElementById('logSessionBtn');
    btn.disabled = true;
    try {
        await api(`/api/circle/${CIRCLE_CODE}/log-session`, {
            method: 'POST',
            body: { partner_id: parseInt(partnerId), duration_minutes: duration, rating: sessionRating }
        });
        showToast('Session logged! üéâ');
        closeModal('sessionModal');
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
    btn.disabled = false;
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

// Load expandable sections when opened
document.querySelectorAll('details').forEach(d => {
    d.addEventListener('toggle', () => {
        if (d.open) {
            const summary = d.querySelector('summary').textContent;
            if (summary.includes('Stats')) { loadStats(); loadRecentSessions(); }
            if (summary.includes('Calendar')) loadCalendar();
            if (summary.includes('Sessions')) loadRecentSessions();
        }
    });
});

// ============ INIT ============
loadStatus();
loadNextCall();
loadInvite();

// Poll every 15 seconds
setInterval(() => { loadStatus(); loadNextCall(); }, 15000);
</script>
{% endblock %}
