{% extends "base.html" %}
{% block title %}{{ circle.name }} - Roleplay Circles{% endblock %}

{% block nav %}
<nav class="nav">
    <div class="nav-inner">
        <a href="/dashboard" class="nav-brand">
            <span>üéØ</span> <span class="nav-user-name">{{ circle.name }}</span>
        </a>
        <div class="nav-links">
            <a href="/settings" class="btn btn-ghost btn-sm">‚öôÔ∏è</a>
            <div class="nav-user">
                {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="" class="nav-avatar">
                {% endif %}
                <span class="nav-user-name">{{ user.name.split(' ')[0] }}</span>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block body %}
<div class="container page">

    <!-- Availability Toggle -->
    <div class="card" id="availCard">
        <div class="toggle-container">
            <button class="toggle-btn" id="availToggle" onclick="toggleAvailability()"></button>
            <div>
                <div class="toggle-label" id="availLabel">Loading...</div>
                <div class="text-sm text-muted" id="availSub"></div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('team')">üë• Team</button>
        <button class="tab" onclick="switchTab('calendar')">üìÖ Calendar</button>
        <button class="tab" onclick="switchTab('stats')">üìä Stats</button>
        <button class="tab" onclick="switchTab('invite')">üîó Invite</button>
    </div>

    <!-- Team Tab -->
    <div class="tab-content active" id="tab-team">
        <div class="section">
            <div class="section-title">
                Team Members <span id="availCount"></span>
            </div>
            <div class="member-grid" id="memberGrid">
                <div class="loading-overlay"><div class="spinner"></div> Loading...</div>
            </div>
        </div>
    </div>

    <!-- Calendar Tab -->
    <div class="tab-content" id="tab-calendar">
        <div class="section">
            <div class="section-title">Today's Calendar</div>
            <div id="calendarEvents">
                <div class="loading-overlay"><div class="spinner"></div> Loading calendar...</div>
            </div>
        </div>
    </div>

    <!-- Stats Tab -->
    <div class="tab-content" id="tab-stats">
        <div class="section">
            <div class="section-title">Your Stats</div>
            <div class="stats-grid" id="statsGrid">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Leaderboard</div>
            <div class="card card-flat" id="leaderboard">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Recent Sessions</div>
            <div id="recentSessions">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Invite Tab -->
    <div class="tab-content" id="tab-invite">
        <div class="card card-flat">
            <div class="card-title mb-2">Invite Your Team</div>
            <p class="text-sm text-muted mb-2">Share this link with teammates to join {{ circle.name }}:</p>

            <div class="invite-box mb-2">
                <div class="invite-url" id="inviteUrl">Loading...</div>
                <button onclick="copyInvite()" class="btn btn-primary btn-sm">üìã Copy</button>
            </div>

            <div class="text-center">
                <div class="text-xs text-muted">Circle Code</div>
                <div style="font-size: 1.5rem; font-weight: 800; letter-spacing: 4px; font-family: monospace; color: var(--accent);">
                    {{ code }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Session Modal -->
<div class="modal-overlay" id="sessionModal">
    <div class="modal">
        <div class="modal-title">üéØ Log Roleplay Session</div>

        <div class="form-group">
            <label class="form-label">Partner</label>
            <select id="sessionPartner" class="form-input">
                <option value="">Select partner...</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Duration (minutes)</label>
            <select id="sessionDuration" class="form-input">
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="15" selected>15 min</option>
                <option value="20">20 min</option>
                <option value="30">30 min</option>
                <option value="45">45 min</option>
                <option value="60">60 min</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Rating (optional)</label>
            <div class="flex gap-1" id="ratingStars">
                <button onclick="setRating(1)" class="btn btn-ghost btn-sm rating-star">‚≠ê</button>
                <button onclick="setRating(2)" class="btn btn-ghost btn-sm rating-star">‚≠ê</button>
                <button onclick="setRating(3)" class="btn btn-ghost btn-sm rating-star">‚≠ê</button>
                <button onclick="setRating(4)" class="btn btn-ghost btn-sm rating-star">‚≠ê</button>
                <button onclick="setRating(5)" class="btn btn-ghost btn-sm rating-star">‚≠ê</button>
            </div>
        </div>

        <div class="flex gap-1">
            <button onclick="submitSession()" class="btn btn-green" id="logSessionBtn">Log Session</button>
            <button onclick="closeModal('sessionModal')" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const CIRCLE_CODE = '{{ code }}';
const MY_ID = {{ user.id }};
let isAvailable = false;
let members = [];
let sessionRating = 0;
let pollInterval;

// ============ TABS ============
function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

    event.target.classList.add('active');
    document.getElementById(`tab-${name}`).classList.add('active');

    if (name === 'calendar') loadCalendar();
    if (name === 'stats') { loadStats(); loadRecentSessions(); }
    if (name === 'invite') loadInvite();
}

// ============ STATUS / TEAM ============
async function loadStatus() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/status`);
        members = data.members;
        isAvailable = data.my_available;

        // Update toggle
        const toggle = document.getElementById('availToggle');
        const label = document.getElementById('availLabel');
        const sub = document.getElementById('availSub');

        toggle.classList.toggle('active', isAvailable);
        label.textContent = isAvailable ? "You're Available" : "You're Unavailable";
        label.classList.toggle('available', isAvailable);
        sub.textContent = `${data.available_count} of ${data.members.length} available`;

        if (data.group_session_ready && isAvailable) {
            sub.textContent += ' ¬∑ Ready to roleplay! üéØ';
        }

        // Update count badge
        document.getElementById('availCount').textContent =
            `(${data.available_count}/${data.members.length})`;

        // Render members
        renderMembers(data.members);
    } catch (err) {
        console.error('Failed to load status:', err);
    }
}

function renderMembers(members) {
    const grid = document.getElementById('memberGrid');
    if (!members.length) {
        grid.innerHTML = '<div class="empty-state"><p>No members yet</p></div>';
        return;
    }

    grid.innerHTML = members.map(m => {
        const initials = m.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
        const avatarHtml = m.avatar_url
            ? `<img src="${m.avatar_url}" alt="" class="member-avatar">`
            : `<div class="member-avatar">${initials}</div>`;

        const classes = ['member-card'];
        if (m.available) classes.push('available');
        if (m.is_me) classes.push('is-me');

        let actions = '';
        if (m.available && !m.is_me && m.zoom_link) {
            actions = `<a href="${m.zoom_link}" target="_blank" class="btn btn-green btn-sm" style="margin-top:6px; font-size:0.8rem;">üìû Join Zoom</a>`;
        }

        return `
            <div class="${classes.join(' ')}">
                ${avatarHtml}
                <div class="member-info">
                    <div class="member-name">${m.name}${m.is_me ? ' (you)' : ''}</div>
                    <div class="member-status">
                        <span class="status-dot ${m.available ? 'online' : 'offline'}"></span>
                        ${m.available ? 'Available' : 'Unavailable'}
                    </div>
                    ${actions}
                </div>
            </div>
        `;
    }).join('');
}

// ============ AVAILABILITY ============
async function toggleAvailability() {
    isAvailable = !isAvailable;
    try {
        await api(`/api/circle/${CIRCLE_CODE}/available`, {
            method: 'POST',
            body: { available: isAvailable }
        });
        loadStatus();

        if (isAvailable) {
            showToast("You're now available! üéØ");
        }
    } catch (err) {
        showToast(err.message, 'error');
        isAvailable = !isAvailable;
    }
}

// ============ CALENDAR ============
async function loadCalendar() {
    const container = document.getElementById('calendarEvents');
    container.innerHTML = '<div class="loading-overlay"><div class="spinner"></div> Loading...</div>';

    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/calendar`);

        if (data.error === 'token_expired') {
            container.innerHTML = `
                <div class="dev-notice">
                    Calendar access expired. <a href="/auth/google">Sign in again</a> to refresh.
                </div>`;
            return;
        }

        if (data.error === 'No access token') {
            container.innerHTML = `
                <div class="dev-notice">
                    Calendar not connected. <a href="/auth/google">Sign in with Google</a> to see your calendar.
                </div>`;
            return;
        }

        if (!data.events || !data.events.length) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <p>No events today</p>
                    <p class="text-sm text-muted">Great time for some roleplay!</p>
                </div>`;
            return;
        }

        container.innerHTML = data.events.map(e => `
            <div class="event-item">
                <div class="event-time">${e.start_time} - ${e.end_time}</div>
                <div class="event-title">${e.summary}</div>
                ${e.needs_noshow_prompt ? `
                    <div class="event-noshow">
                        <button onclick="markNoShow('${e.uid}', '${e.summary.replace(/'/g, "\\'")}')"
                                class="btn btn-danger btn-sm">No-show?</button>
                    </div>
                ` : ''}
            </div>
        `).join('');

    } catch (err) {
        container.innerHTML = `
            <div class="empty-state">
                <p class="text-muted">${err.message}</p>
            </div>`;
    }
}

async function markNoShow(uid, summary) {
    try {
        await api(`/api/circle/${CIRCLE_CODE}/noshow`, {
            method: 'POST',
            body: { event_uid: uid, event_summary: summary }
        });
        showToast("No-show marked. You're now available! üéØ");
        loadStatus();
        loadCalendar();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ STATS ============
async function loadStats() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/stats`);

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${data.my_sessions_this_week}</div>
                <div class="stat-label">This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.my_total_sessions}</div>
                <div class="stat-label">Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.my_streak}üî•</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.my_noshows}</div>
                <div class="stat-label">No-Shows Caught</div>
            </div>
        `;

        // Leaderboard
        if (data.leaderboard.length) {
            document.getElementById('leaderboard').innerHTML = data.leaderboard.map((p, i) => `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank ${i < 3 ? 'top-' + (i+1) : ''}">
                        ${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#' + (i+1)}
                    </div>
                    <div class="leaderboard-name ${p.is_me ? 'is-me' : ''}">${p.name}${p.is_me ? ' (you)' : ''}</div>
                    <div class="leaderboard-count">${p.sessions}</div>
                </div>
            `).join('');
        } else {
            document.getElementById('leaderboard').innerHTML = `
                <div class="empty-state">
                    <p class="text-sm text-muted">No sessions logged yet. Be the first!</p>
                </div>`;
        }
    } catch (err) {
        console.error(err);
    }
}

async function loadRecentSessions() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/recent-sessions`);
        const container = document.getElementById('recentSessions');

        if (!data.sessions.length) {
            container.innerHTML = `
                <div class="empty-state">
                    <p class="text-sm text-muted">No sessions yet</p>
                </div>`;
            return;
        }

        container.innerHTML = '<div class="card card-flat">' + data.sessions.map(s => `
            <div class="session-item">
                <div>
                    <div class="session-people">${s.user1_name} ‚Üî ${s.user2_name}</div>
                    <div class="session-meta">${s.duration_minutes}min${s.rating ? ' ¬∑ ' + '‚≠ê'.repeat(s.rating) : ''}</div>
                </div>
                <div class="session-meta">${timeAgo(s.created_at)}</div>
            </div>
        `).join('') + '</div>';
    } catch (err) {
        console.error(err);
    }
}

// ============ INVITE ============
async function loadInvite() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/invite`);
        document.getElementById('inviteUrl').textContent = data.invite_url;
    } catch (err) {
        console.error(err);
    }
}

function copyInvite() {
    const url = document.getElementById('inviteUrl').textContent;
    copyToClipboard(url);
}

// ============ LOG SESSION ============
function openLogSession() {
    const select = document.getElementById('sessionPartner');
    select.innerHTML = '<option value="">Select partner...</option>';
    members.filter(m => !m.is_me).forEach(m => {
        select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
    });
    sessionRating = 0;
    updateRatingStars();
    document.getElementById('sessionModal').classList.add('active');
}

function setRating(n) {
    sessionRating = n;
    updateRatingStars();
}

function updateRatingStars() {
    document.querySelectorAll('.rating-star').forEach((btn, i) => {
        btn.style.opacity = i < sessionRating ? '1' : '0.3';
    });
}

async function submitSession() {
    const partnerId = document.getElementById('sessionPartner').value;
    const duration = parseInt(document.getElementById('sessionDuration').value);

    if (!partnerId) return showToast('Select a partner', 'error');

    const btn = document.getElementById('logSessionBtn');
    btn.disabled = true;

    try {
        await api(`/api/circle/${CIRCLE_CODE}/log-session`, {
            method: 'POST',
            body: {
                partner_id: parseInt(partnerId),
                duration_minutes: duration,
                rating: sessionRating
            }
        });
        showToast('Session logged! üéâ');
        closeModal('sessionModal');
        loadStatus();
        btn.disabled = false;
    } catch (err) {
        showToast(err.message, 'error');
        btn.disabled = false;
    }
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

// ============ INIT ============
loadStatus();
loadInvite();

// Add log session FAB
const fab = document.createElement('button');
fab.className = 'btn btn-primary';
fab.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:50; padding:12px 24px; box-shadow:0 4px 20px rgba(99,102,241,0.4); border-radius:100px;';
fab.innerHTML = 'üéØ Log Session';
fab.onclick = openLogSession;
document.body.appendChild(fab);

// Poll for updates every 15 seconds
pollInterval = setInterval(loadStatus, 15000);
</script>
{% endblock %}
