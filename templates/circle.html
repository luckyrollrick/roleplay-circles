{% extends "base.html" %}
{% block title %}{{ circle.name }}{% endblock %}

{% block nav %}
<nav class="nav" style="padding:8px 12px;">
    <div class="nav-inner">
        <a href="/dashboard" class="nav-brand" style="font-size:0.9rem;">
            <span>üè†</span> {{ circle.name }}
        </a>
        <div class="nav-links">
            <a href="/dashboard" class="btn btn-ghost btn-sm" style="padding:4px 8px;" title="Home">‚Üê Home</a>
            <a href="/settings" class="btn btn-ghost btn-sm" style="padding:4px 8px;">‚öôÔ∏è</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block body %}
<div style="max-width:360px; margin:0 auto; padding:12px;">

    <!-- Pending Invite Banner (received) -->
    <div id="inviteBanner" style="display:none; margin-bottom:12px;"></div>

    <!-- Sent Invite Waiting Banner -->
    <div id="sentInviteBanner" style="display:none; margin-bottom:12px;"></div>

    <!-- Active Session Banner (when you're in one) -->
    <div id="mySessionBanner" style="display:none; margin-bottom:12px;"></div>

    <!-- Availability Toggle -->
    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm); margin-bottom:12px;" id="availCard">
        <div>
            <div style="font-weight:700; font-size:0.9rem;" id="availLabel">Loading...</div>
            <div class="text-xs text-muted" id="availSub"></div>
        </div>
        <button class="toggle-btn" id="availToggle" onclick="toggleAvailability()"></button>
    </div>

    <!-- Active Sessions in Circle -->
    <div id="activeSessionsSection" style="display:none; margin-bottom:12px;">
        <div class="text-xs text-muted" style="margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
            üî¥ Live Sessions
        </div>
        <div id="activeSessionsList"></div>
    </div>

    <!-- Current / Next Call (compact) -->
    <div id="nextCallSection" style="display:none; margin-bottom:12px;">
        <div class="text-xs text-muted" style="margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Current Call</div>
        <div id="nextCallCard" style="padding:10px 14px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm);"></div>
    </div>

    <!-- Who's Available -->
    <div style="margin-bottom:12px;">
        <div class="text-xs text-muted" style="margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
            Team <span id="availCount"></span>
        </div>
        <div id="memberList"></div>
    </div>

    <!-- Compact Actions -->
    <div style="display:flex; gap:8px;" id="actionButtons">
        <button onclick="openLogSession()" class="btn btn-secondary btn-sm" style="flex:1; font-size:0.8rem;">üéØ Log Session</button>
        <button onclick="copyInvite()" class="btn btn-secondary btn-sm" style="flex:1; font-size:0.8rem;" id="inviteBtn">üîó Invite</button>
    </div>

    <!-- Expandable sections -->
    <details style="margin-top:12px;">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">üìä Stats & Leaderboard</summary>
        <div style="padding-top:8px;">
            <div class="stats-grid" id="statsGrid" style="grid-template-columns: repeat(2, 1fr); gap:8px;"></div>
            <div id="leaderboard" style="margin-top:8px;"></div>
        </div>
    </details>

    <details style="margin-top:8px;">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">üìÖ Full Calendar</summary>
        <div id="calendarEvents" style="padding-top:8px;"></div>
    </details>

    <details style="margin-top:8px;">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">üìã Recent Sessions</summary>
        <div id="recentSessions" style="padding-top:8px;"></div>
    </details>

    <!-- Circle Settings (Admin only) -->
    <details style="margin-top:8px; display:none;" id="adminSettingsSection">
        <summary class="text-xs text-muted" style="cursor:pointer; padding:6px 0; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">‚öôÔ∏è Circle Settings (Admin)</summary>
        <div style="padding-top:8px;">
            <div style="padding:12px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm); margin-bottom:8px;">
                <div class="form-group" style="margin-bottom:8px;">
                    <label class="form-label" style="font-size:0.8rem;">Circle Name</label>
                    <input type="text" id="settingCircleName" class="form-input" value="{{ circle.name }}" style="font-size:0.85rem;">
                </div>
                <div class="form-group" style="margin-bottom:8px;">
                    <label class="form-label" style="font-size:0.8rem;">Max Session Size</label>
                    <select id="settingMaxSize" class="form-input" style="font-size:0.85rem;">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="8">8</option>
                        <option value="10">10</option>
                    </select>
                </div>
                <button onclick="saveCircleSettings()" class="btn btn-primary btn-sm" id="saveSettingsBtn" style="font-size:0.8rem;">Save Settings</button>
            </div>

            <!-- Member Management -->
            <div class="text-xs text-muted" style="margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
                üë• Members
            </div>
            <div id="adminMemberList"></div>
        </div>
    </details>
</div>

<!-- Invite Confirmation Modal -->
<div class="modal-overlay" id="inviteModal">
    <div class="modal" style="max-width:340px; padding:20px;">
        <div class="modal-title" style="font-size:0.9rem;">üéØ Invite to Roleplay?</div>
        <div id="inviteModalBody" style="font-size:0.85rem; margin-bottom:16px;"></div>
        <div class="flex gap-1">
            <button onclick="confirmSendInvite()" class="btn btn-green btn-sm" id="sendInviteBtn">Send Invite</button>
            <button onclick="closeModal('inviteModal')" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
    </div>
</div>

<!-- End Session Modal -->
<div class="modal-overlay" id="endSessionModal">
    <div class="modal" style="max-width:340px; padding:20px;">
        <div class="modal-title" style="font-size:0.9rem;">üèÅ End Session</div>
        <div id="endSessionBody" style="font-size:0.85rem; margin-bottom:12px;"></div>
        <div class="form-group">
            <label class="form-label">Rating</label>
            <div class="flex gap-1" id="endRatingStars">
                <button onclick="setEndRating(1)" class="btn btn-ghost btn-sm end-rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setEndRating(2)" class="btn btn-ghost btn-sm end-rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setEndRating(3)" class="btn btn-ghost btn-sm end-rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setEndRating(4)" class="btn btn-ghost btn-sm end-rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setEndRating(5)" class="btn btn-ghost btn-sm end-rating-star" style="padding:2px 6px;">‚≠ê</button>
            </div>
        </div>
        <div class="flex gap-1" style="flex-wrap:wrap;">
            <button onclick="endSessionAction(true)" class="btn btn-green btn-sm">End & Go Available</button>
            <button onclick="endSessionAction(false)" class="btn btn-secondary btn-sm">End Session</button>
            <button onclick="closeModal('endSessionModal')" class="btn btn-ghost btn-sm" style="width:100%; margin-top:4px;">Cancel</button>
        </div>
    </div>
</div>

<!-- Log Session Modal -->
<div class="modal-overlay" id="sessionModal">
    <div class="modal" style="max-width:340px; padding:20px;">
        <div class="modal-title" style="font-size:0.9rem;">üéØ Log Session</div>
        <div class="form-group">
            <label class="form-label">Partner</label>
            <select id="sessionPartner" class="form-input">
                <option value="">Select...</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Duration</label>
            <select id="sessionDuration" class="form-input">
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="15" selected>15 min</option>
                <option value="20">20 min</option>
                <option value="30">30 min</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Rating</label>
            <div class="flex gap-1" id="ratingStars">
                <button onclick="setRating(1)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(2)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(3)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(4)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
                <button onclick="setRating(5)" class="btn btn-ghost btn-sm rating-star" style="padding:2px 6px;">‚≠ê</button>
            </div>
        </div>
        <div class="flex gap-1">
            <button onclick="submitSession()" class="btn btn-green btn-sm" id="logSessionBtn">Log</button>
            <button onclick="closeModal('sessionModal')" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const CIRCLE_CODE = '{{ code }}';
const MY_ID = {{ user.id }};
let isAvailable = false;
let isAdmin = false;
let members = [];
let maxSessionSize = 4;
let sessionRating = 0;
let endSessionRating = 0;
let pendingInviteTarget = null;
let currentSessionId = null;
let sessionTimerInterval = null;
let previousPendingInviteIds = new Set();
let notificationsEnabled = false;

// ============ NOTIFICATIONS ============
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(perm => {
            notificationsEnabled = perm === 'granted';
        });
    } else if ('Notification' in window && Notification.permission === 'granted') {
        notificationsEnabled = true;
    }
}

function showBrowserNotification(title, body) {
    if (!notificationsEnabled) return;
    try {
        const n = new Notification(title, {
            body: body,
            icon: 'üéØ',
            tag: 'roleplay-invite',
            requireInteraction: true,
        });
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2JkZeWj4F1bGVnc4GOlpqXjn5xa2Rle4mXoJuShn1xaGNofJCcoZmMgHRpZWp+kZ6gnpKFd21naHuMm6CdlIh7cGtqd4eSm5yYj4N3cG1wfIyYm5mTh3xybm94iJWamZWLf3VwcHWDj5iZl5GGfHNxcnaBjJWYlpKIf3ZzcnR/i5OWlZOKgXl1c3V+iZGUlJKLg3t3dXZ8ho6SkZGLhH15d3d7hIuQkJCLhYB8eXl7goiNj4+MhoJ+e3p7gYaMjo6MhoOAfXt7gIWKjI2MiIWCf317gIKHiouLioiFg4B+foCEh4mKioqIhYOBf36AgoaIiYmJiIaEgoF/gIKEhoeIiImIhoWEgoGAgoOFhoiIiIiHhoWDgoGBgoSFhoeHh4eHhoaFhIODgoODhIWFhoeHh4eGhoWEhIODg4OEhYaGh4eHh4eGhoWFhIODhIOEhYWGhoeHh4eHhoaFhYSDhIOEhIWFhoaHh4eHh4eGhoaFhYSEhIOEhIWFhoaHh4eHh4eHhoaGhYWEhISDhISFhYaGh4eHh4eH');
            audio.volume = 0.3;
            audio.play().catch(() => {});
        } catch(e) {}
        setTimeout(() => n.close(), 10000);
    } catch(e) {}
}

// ============ HEARTBEAT ============
function sendHeartbeat() {
    return fetch(`/api/circle/${CIRCLE_CODE}/heartbeat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{}',
    }).catch(() => {});
}

// Send heartbeat every 10 seconds
setInterval(sendHeartbeat, 10000);

// Send heartbeat immediately and wait for it before first status load
// This prevents a race condition where status check runs stale detection
// before the heartbeat updates last_seen (e.g. on page refresh)
let heartbeatReady = sendHeartbeat().then(() => true).catch(() => true);

// ============ PRESENCE ============
// No beforeunload ‚Äî we rely on heartbeat timeout instead.
// If the tab closes, heartbeats stop, and the server auto-sets
// the user unavailable after 30 seconds of silence.
// This avoids false positives from refresh, internal nav, etc.

// ============ STATUS ============
async function loadStatus() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/status`);
        members = data.members;
        isAvailable = data.my_available;
        isAdmin = data.is_admin;
        maxSessionSize = data.max_session_size || 4;

        // Show/hide admin sections
        const adminSection = document.getElementById('adminSettingsSection');
        const inviteBtn = document.getElementById('inviteBtn');
        if (isAdmin) {
            adminSection.style.display = 'block';
            inviteBtn.style.display = '';
        } else {
            adminSection.style.display = 'none';
            inviteBtn.style.display = 'none';
        }

        // Auto-timeout notification
        if (data.auto_timed_out) {
            showToast("You've been set to unavailable due to inactivity", 'error');
        }

        const toggle = document.getElementById('availToggle');
        const label = document.getElementById('availLabel');
        const sub = document.getElementById('availSub');

        // Determine current user state
        const myMember = data.members.find(m => m.is_me);
        const myState = myMember ? myMember.state : 'unavailable';

        if (myState === 'in_session') {
            toggle.classList.add('active');
            label.textContent = "In Session üî¥";
            sub.textContent = `${data.available_count} of ${data.members.length} free`;
        } else {
            toggle.classList.toggle('active', isAvailable);
            label.textContent = isAvailable ? "You're Available üü¢" : "You're Unavailable";
            sub.textContent = `${data.available_count} of ${data.members.length} free`;
            if (data.group_session_ready && isAvailable) {
                sub.textContent += ' ‚Äî Go! üéØ';
            }
        }

        document.getElementById('availCount').textContent = `(${data.available_count}/${data.members.length})`;

        // Render members
        renderMembers(data.members, data.sent_pending_invites);

        // Render active sessions
        renderActiveSessions(data.active_sessions, data.my_active_session);

        // Render pending invites (received)
        renderPendingInvites(data.pending_invites);

        // Render sent pending invites
        renderSentPendingInvites(data.sent_pending_invites);

        // Track my active session for timer
        if (data.my_active_session) {
            if (currentSessionId !== data.my_active_session.id) {
                currentSessionId = data.my_active_session.id;
                startSessionTimer(data.my_active_session.started_at);
            }
        } else {
            if (currentSessionId) {
                currentSessionId = null;
                stopSessionTimer();
            }
        }

        // Update admin settings if open
        if (isAdmin) {
            document.getElementById('settingMaxSize').value = maxSessionSize;
        }

    } catch (err) {
        console.error('Failed to load status:', err);
    }
}

function renderMembers(members, sentPending) {
    const list = document.getElementById('memberList');
    if (!members.length) {
        list.innerHTML = '<div class="text-sm text-muted" style="padding:12px;">No members yet</div>';
        return;
    }

    const sentPendingUserIds = new Set((sentPending || []).map(i => i.to_user_id));

    // Sort: in_session first, then available, then unavailable
    const stateOrder = { in_session: 0, available: 1, unavailable: 2 };
    const sorted = [...members].sort((a, b) => {
        const sa = stateOrder[a.state] ?? 2;
        const sb = stateOrder[b.state] ?? 2;
        if (sa !== sb) return sa - sb;
        return a.name.localeCompare(b.name);
    });

    list.innerHTML = sorted.map(m => {
        let dotClass, border, bg, stateLabel;

        if (m.state === 'in_session') {
            dotClass = 'online';
            border = 'border-color:var(--orange);';
            bg = 'background:var(--orange-dim);';
            stateLabel = '<span style="font-size:0.65rem; color:var(--orange); font-weight:600;">IN SESSION</span>';
        } else if (m.state === 'available') {
            dotClass = 'online';
            border = 'border-color:var(--green);';
            bg = 'background:var(--green-dim);';
            stateLabel = '';
        } else {
            dotClass = 'offline';
            border = '';
            bg = '';
            stateLabel = '';
        }

        let action = '';
        if (m.state === 'available' && !m.is_me) {
            if (sentPendingUserIds.has(m.id)) {
                action = `<span style="font-size:0.7rem; color:var(--orange); font-weight:600; animation: pulse 1.5s infinite;">Waiting...</span>`;
            } else {
                action = `<button onclick="openInviteModal(${m.id}, '${m.name.replace(/'/g, "\\'")}')" class="btn btn-green btn-sm" style="padding:3px 10px; font-size:0.75rem;">üéØ Invite</button>`;
            }
        }

        return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg-card); border:2px solid var(--border); border-radius:var(--radius-sm); margin-bottom:4px; ${border}${bg}">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="status-dot ${dotClass}"></span>
                    <div>
                        <span style="font-size:0.85rem; font-weight:600;">${m.name}${m.is_me ? ' (you)' : ''}${m.role === 'admin' ? ' üëë' : ''}</span>
                        ${stateLabel ? '<br>' + stateLabel : ''}
                    </div>
                </div>
                ${action}
            </div>
        `;
    }).join('');
}

// ============ ACTIVE SESSIONS ============
function renderActiveSessions(sessions, mySession) {
    const section = document.getElementById('activeSessionsSection');
    const list = document.getElementById('activeSessionsList');
    const banner = document.getElementById('mySessionBanner');

    // Show my session banner if I'm in one
    if (mySession) {
        const memberNames = mySession.members.map(m => m.name).join(' & ');
        const canEndForAll = isAdmin || mySession.started_by === MY_ID;

        banner.style.display = 'block';
        banner.innerHTML = `
            <div style="padding:14px 16px; background:var(--orange-dim); border:2px solid var(--orange); border-radius:var(--radius-sm);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div style="font-weight:700; font-size:0.9rem; color:var(--orange);">üî¥ In Session</div>
                    <div id="sessionTimer" style="font-family:var(--font-pixel); font-size:0.7rem; color:var(--orange);"></div>
                </div>
                <div style="font-size:0.85rem; margin-bottom:8px;">${memberNames}</div>
                ${mySession.zoom_link ? `<a href="${mySession.zoom_link}" target="_blank" class="btn btn-green btn-sm" style="padding:4px 12px; font-size:0.75rem; margin-bottom:8px; display:inline-block;">üìπ Join Zoom</a>` : ''}
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button onclick="leaveSession(${mySession.id})" class="btn btn-secondary btn-sm" style="font-size:0.75rem;">üö™ Leave</button>
                    ${canEndForAll ? `<button onclick="openEndSession(${mySession.id})" class="btn btn-secondary btn-sm" style="font-size:0.75rem;">üèÅ End for All</button>` : ''}
                </div>
            </div>
        `;
    } else {
        banner.style.display = 'none';
    }

    // Show other active sessions for the circle (not including mine)
    const otherSessions = sessions.filter(s => !s.members.some(m => m.is_me));

    if (otherSessions.length > 0) {
        section.style.display = 'block';
        list.innerHTML = otherSessions.map(s => {
            const names = s.members.map(m => m.name).join(' & ');
            const memberCount = s.members.length;
            const isFull = memberCount >= maxSessionSize;

            let joinBtn;
            if (isFull) {
                joinBtn = `<span style="font-size:0.7rem; color:var(--text-muted); font-weight:600;">Full (${memberCount}/${maxSessionSize})</span>`;
            } else {
                joinBtn = `<button onclick="joinSession(${s.id})" class="btn btn-green btn-sm" style="padding:3px 10px; font-size:0.75rem;">Join (${memberCount}/${maxSessionSize})</button>`;
            }

            return `
                <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg-card); border:2px solid var(--orange); border-radius:var(--radius-sm); margin-bottom:4px; background:var(--orange-dim);">
                    <div>
                        <div style="font-size:0.8rem; font-weight:600;">${names}</div>
                        <div class="text-xs text-muted">Roleplaying now</div>
                    </div>
                    ${joinBtn}
                </div>
            `;
        }).join('');
    } else {
        section.style.display = 'none';
    }
}

// ============ SESSION TIMER ============
function startSessionTimer(startedAt) {
    stopSessionTimer();
    const startTime = new Date(startedAt + 'Z'); // UTC
    function update() {
        const now = new Date();
        const diff = Math.max(0, Math.floor((now - startTime) / 1000));
        const mins = Math.floor(diff / 60);
        const secs = diff % 60;
        const el = document.getElementById('sessionTimer');
        if (el) {
            el.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
    }
    update();
    sessionTimerInterval = setInterval(update, 1000);
}

function stopSessionTimer() {
    if (sessionTimerInterval) {
        clearInterval(sessionTimerInterval);
        sessionTimerInterval = null;
    }
}

// ============ INVITE FLOW ============
function openInviteModal(userId, userName) {
    pendingInviteTarget = userId;
    document.getElementById('inviteModalBody').textContent = `Send a roleplay invite to ${userName}? They'll have 60 seconds to accept.`;
    document.getElementById('inviteModal').classList.add('active');

    requestNotificationPermission();
}

async function confirmSendInvite() {
    if (!pendingInviteTarget) return;
    const btn = document.getElementById('sendInviteBtn');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    try {
        await api(`/api/circle/${CIRCLE_CODE}/send-invite`, {
            method: 'POST',
            body: { to_user_id: pendingInviteTarget }
        });
        showToast('Invite sent! ‚è≥');
        closeModal('inviteModal');
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
    btn.disabled = false;
    btn.textContent = 'Send Invite';
    pendingInviteTarget = null;
}

function renderPendingInvites(invites) {
    const banner = document.getElementById('inviteBanner');
    if (!invites || !invites.length) {
        banner.style.display = 'none';
        return;
    }

    invites.forEach(inv => {
        if (!previousPendingInviteIds.has(inv.id)) {
            showBrowserNotification('üéØ Roleplay Invite!', `${inv.from_name} wants to roleplay with you!`);
        }
    });
    previousPendingInviteIds = new Set(invites.map(i => i.id));

    banner.style.display = 'block';
    banner.innerHTML = invites.map(inv => `
        <div style="padding:14px 16px; background:var(--green-dim); border:2px solid var(--green); border-radius:var(--radius-sm); animation: pulse 1.5s infinite;">
            <div style="font-weight:700; font-size:0.9rem; margin-bottom:6px;">üéØ ${inv.from_name} wants to roleplay!</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button onclick="respondInvite(${inv.id}, 'accept')" class="btn btn-green btn-sm" style="font-size:0.8rem;">‚úÖ Accept</button>
                <button onclick="respondInvite(${inv.id}, 'decline', 'Busy')" class="btn btn-secondary btn-sm" style="font-size:0.8rem;">Busy</button>
                <button onclick="respondInvite(${inv.id}, 'decline', 'In a call')" class="btn btn-secondary btn-sm" style="font-size:0.8rem;">In a call</button>
                <button onclick="respondInvite(${inv.id}, 'decline', 'Maybe later')" class="btn btn-secondary btn-sm" style="font-size:0.8rem;">Later</button>
            </div>
        </div>
    `).join('');
}

function renderSentPendingInvites(sentInvites) {
    const banner = document.getElementById('sentInviteBanner');
    if (!sentInvites || !sentInvites.length) {
        banner.style.display = 'none';
        return;
    }

    banner.style.display = 'block';
    banner.innerHTML = sentInvites.map(inv => `
        <div style="padding:10px 14px; background:var(--bg-card); border:2px solid var(--orange); border-radius:var(--radius-sm);">
            <div style="font-size:0.85rem; font-weight:600; color:var(--orange);">‚è≥ Waiting for ${inv.to_name}...</div>
            <div class="text-xs text-muted" style="margin-top:2px;">Invite expires in 60s</div>
            <button onclick="cancelInvite(${inv.id})" class="btn btn-ghost btn-sm" style="font-size:0.7rem; margin-top:6px; color:var(--text-muted);">Cancel</button>
        </div>
    `).join('');
}

async function respondInvite(inviteId, response, reason) {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/respond-invite`, {
            method: 'POST',
            body: { invite_id: inviteId, response: response, decline_reason: reason || '' }
        });
        if (response === 'accept') {
            showToast('Session started! üéØ');
            if (data.zoom_link) {
                window.open(data.zoom_link, '_blank');
            }
        } else {
            showToast('Invite declined');
        }
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

async function cancelInvite(inviteId) {
    try {
        await api(`/api/circle/${CIRCLE_CODE}/cancel-invite`, {
            method: 'POST',
            body: { invite_id: inviteId }
        });
        showToast('Invite cancelled');
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ JOIN SESSION ============
async function joinSession(sessionId) {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/join-session`, {
            method: 'POST',
            body: { session_id: sessionId }
        });
        showToast('Joined session! üéØ');
        if (data.zoom_link) {
            window.open(data.zoom_link, '_blank');
        }
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ LEAVE SESSION ============
async function leaveSession(sessionId) {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/leave-session`, {
            method: 'POST',
            body: { session_id: sessionId }
        });
        showToast(data.session_ended ? 'Session ended (last person left)' : 'Left session');
        stopSessionTimer();
        currentSessionId = null;
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ END SESSION ============
function openEndSession(sessionId) {
    currentEndSessionId = sessionId;
    endSessionRating = 0;
    updateEndRatingStars();

    const timerEl = document.getElementById('sessionTimer');
    const duration = timerEl ? timerEl.textContent : '';

    document.getElementById('endSessionBody').textContent = `Session duration: ${duration || 'calculating...'}. This will end the session for everyone.`;
    document.getElementById('endSessionModal').classList.add('active');
}

let currentEndSessionId = null;

function setEndRating(n) {
    endSessionRating = n;
    updateEndRatingStars();
}

function updateEndRatingStars() {
    document.querySelectorAll('.end-rating-star').forEach((btn, i) => {
        btn.style.opacity = i < endSessionRating ? '1' : '0.3';
    });
}

async function endSessionAction(goAvailable) {
    if (!currentEndSessionId) return;
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/end-session`, {
            method: 'POST',
            body: {
                session_id: currentEndSessionId,
                go_available: goAvailable,
                rating: endSessionRating,
            }
        });
        showToast(`Session ended! ${data.duration_minutes} minutes logged üéâ`);
        closeModal('endSessionModal');
        currentEndSessionId = null;
        stopSessionTimer();
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ NEXT CALL ============
async function loadNextCall() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/calendar`);
        const section = document.getElementById('nextCallSection');
        const card = document.getElementById('nextCallCard');

        if (!data.events || !data.events.length) {
            section.style.display = 'none';
            return;
        }

        const e = data.events[0];
        section.style.display = 'block';

        let noshowBtn = '';
        if (e.needs_noshow_prompt) {
            noshowBtn = `<button onclick="markNoShow('${e.uid}', '${e.summary.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" style="padding:3px 10px; font-size:0.75rem; margin-top:6px;">No-show? Go available</button>`;
        }

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <div style="font-weight:600; font-size:0.85rem;">${e.summary}</div>
                    <div class="text-xs text-muted">${e.start_time} ‚Äì ${e.end_time}${e.calendar ? ' ¬∑ ' + e.calendar : ''}</div>
                    ${noshowBtn}
                </div>
            </div>
        `;
    } catch (err) {
        document.getElementById('nextCallSection').style.display = 'none';
    }
}

// ============ AVAILABILITY ============
async function toggleAvailability() {
    const myMember = members.find(m => m.is_me);
    if (myMember && myMember.state === 'in_session') {
        showToast('End your session first', 'error');
        return;
    }

    isAvailable = !isAvailable;
    try {
        await api(`/api/circle/${CIRCLE_CODE}/available`, {
            method: 'POST',
            body: { available: isAvailable }
        });
        loadStatus();
        if (isAvailable) {
            showToast("You're available! üéØ");
            requestNotificationPermission();
        }
    } catch (err) {
        showToast(err.message, 'error');
        isAvailable = !isAvailable;
    }
}

// ============ NO SHOW ============
async function markNoShow(uid, summary) {
    try {
        await api(`/api/circle/${CIRCLE_CODE}/noshow`, {
            method: 'POST',
            body: { event_uid: uid, event_summary: summary }
        });
        showToast("No-show! You're available üéØ");
        loadStatus();
        loadNextCall();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============ FULL CALENDAR (expandable) ============
async function loadCalendar() {
    const container = document.getElementById('calendarEvents');
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/calendar`);
        if (!data.events || !data.events.length) {
            container.innerHTML = '<div class="text-sm text-muted">No more events today</div>';
            return;
        }
        container.innerHTML = data.events.map(e => `
            <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.8rem;">
                <span class="text-muted" style="min-width:55px;">${e.start_time}</span>
                <span style="flex:1;">${e.summary}</span>
                ${e.needs_noshow_prompt ? `<button onclick="markNoShow('${e.uid}', '${e.summary.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" style="padding:2px 8px;font-size:0.7rem;">No-show</button>` : ''}
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div class="text-sm text-muted">Could not load calendar</div>';
    }
}

// ============ STATS (expandable) ============
async function loadStats() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/stats`);
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_sessions_this_week}</div>
                <div class="stat-label">This Week</div>
            </div>
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_total_sessions}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_streak}üî•</div>
                <div class="stat-label">Streak</div>
            </div>
            <div class="stat-card" style="padding:10px;">
                <div class="stat-value" style="font-size:1.3rem;">${data.my_noshows}</div>
                <div class="stat-label">No-Shows</div>
            </div>
        `;

        const lb = document.getElementById('leaderboard');
        if (data.leaderboard.length) {
            lb.innerHTML = data.leaderboard.map((p, i) => `
                <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.8rem;">
                    <span style="width:20px; text-align:center; font-weight:700;">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#'+(i+1)}</span>
                    <span style="flex:1; font-weight:${p.is_me ? '700' : '400'}; ${p.is_me ? 'color:var(--accent);' : ''}">${p.name}</span>
                    <span style="font-weight:700;">${p.sessions}</span>
                </div>
            `).join('');
        } else {
            lb.innerHTML = '<div class="text-sm text-muted">No sessions yet</div>';
        }
    } catch (err) {
        console.error(err);
    }
}

async function loadRecentSessions() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/recent-sessions`);
        const container = document.getElementById('recentSessions');
        if (!data.sessions.length) {
            container.innerHTML = '<div class="text-sm text-muted">No sessions yet</div>';
            return;
        }
        container.innerHTML = data.sessions.map(s => `
            <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.8rem;">
                <span>${s.user1_name} ‚Üî ${s.user2_name} ¬∑ ${s.duration_minutes}min</span>
                <span class="text-muted">${timeAgo(s.created_at)}</span>
            </div>
        `).join('');
    } catch (err) {
        console.error(err);
    }
}

// ============ INVITE LINK ============
let inviteUrl = '';
async function loadInvite() {
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/invite`);
        inviteUrl = data.invite_url;
    } catch (err) {
        // Not admin or error - hide invite button
        inviteUrl = '';
    }
}

function copyInvite() {
    if (!isAdmin) {
        showToast('Only admins can share the invite link', 'error');
        return;
    }
    if (inviteUrl) {
        copyToClipboard(inviteUrl);
    } else {
        showToast('Loading invite...', 'error');
        loadInvite();
    }
}

// ============ LOG SESSION (manual) ============
function openLogSession() {
    const select = document.getElementById('sessionPartner');
    select.innerHTML = '<option value="">Select...</option>';
    members.filter(m => !m.is_me).forEach(m => {
        select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
    });
    sessionRating = 0;
    updateRatingStars();
    document.getElementById('sessionModal').classList.add('active');
}

function setRating(n) {
    sessionRating = n;
    updateRatingStars();
}

function updateRatingStars() {
    document.querySelectorAll('.rating-star').forEach((btn, i) => {
        btn.style.opacity = i < sessionRating ? '1' : '0.3';
    });
}

async function submitSession() {
    const partnerId = document.getElementById('sessionPartner').value;
    const duration = parseInt(document.getElementById('sessionDuration').value);
    if (!partnerId) return showToast('Select a partner', 'error');

    const btn = document.getElementById('logSessionBtn');
    btn.disabled = true;
    try {
        await api(`/api/circle/${CIRCLE_CODE}/log-session`, {
            method: 'POST',
            body: { partner_id: parseInt(partnerId), duration_minutes: duration, rating: sessionRating }
        });
        showToast('Session logged! üéâ');
        closeModal('sessionModal');
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
    btn.disabled = false;
}

// ============ CIRCLE SETTINGS (Admin) ============
async function saveCircleSettings() {
    const btn = document.getElementById('saveSettingsBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    try {
        await api(`/api/circle/${CIRCLE_CODE}/settings`, {
            method: 'POST',
            body: {
                name: document.getElementById('settingCircleName').value.trim(),
                max_session_size: parseInt(document.getElementById('settingMaxSize').value),
            }
        });
        showToast('Settings saved!');
        loadStatus();
    } catch (err) {
        showToast(err.message, 'error');
    }
    btn.disabled = false;
    btn.textContent = 'Save Settings';
}

async function loadAdminMembers() {
    if (!isAdmin) return;
    try {
        const data = await api(`/api/circle/${CIRCLE_CODE}/settings`);
        const list = document.getElementById('adminMemberList');
        list.innerHTML = data.members.map(m => {
            const kickBtn = m.role !== 'admin' && m.id !== MY_ID
                ? `<button onclick="kickMember(${m.id}, '${m.name.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" style="padding:2px 8px; font-size:0.7rem;">‚úï Kick</button>`
                : (m.role === 'admin' ? '<span style="font-size:0.7rem; color:var(--text-muted);">üëë Admin</span>' : '');
            return `
                <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 10px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:3px; font-size:0.8rem;">
                    <span>${m.name}</span>
                    ${kickBtn}
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error(err);
    }
}

async function kickMember(userId, userName) {
    if (!confirm(`Kick ${userName} from this circle?`)) return;
    try {
        await api(`/api/circle/${CIRCLE_CODE}/members/${userId}`, {
            method: 'DELETE',
        });
        showToast(`${userName} has been kicked`);
        loadStatus();
        loadAdminMembers();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

// Load expandable sections when opened
document.querySelectorAll('details').forEach(d => {
    d.addEventListener('toggle', () => {
        if (d.open) {
            const summary = d.querySelector('summary').textContent;
            if (summary.includes('Stats')) { loadStats(); loadRecentSessions(); }
            if (summary.includes('Calendar')) loadCalendar();
            if (summary.includes('Sessions')) loadRecentSessions();
            if (summary.includes('Circle Settings')) loadAdminMembers();
        }
    });
});

// ============ INIT ============
// Wait for first heartbeat before loading status to avoid stale detection race
heartbeatReady.then(() => loadStatus());
loadNextCall();
loadInvite();

// Poll: 5 seconds for invites/status (combined), 15 seconds for calendar
setInterval(() => { loadStatus(); }, 5000);
setInterval(() => { loadNextCall(); }, 15000);
</script>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}
</style>
{% endblock %}
