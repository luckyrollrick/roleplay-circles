<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleplay Circles</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="widget">
        <header>
            <h1>üéØ Roleplay Circles</h1>
            <div class="user-select">
                <select id="userSelect" onchange="switchUser()">
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if user and u.id == user.id %}selected{% endif %}>{{ u.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </header>

        <!-- Notification Banner -->
        <div id="notification" class="notification hidden">
            <span id="notificationText"></span>
            <button onclick="hideNotification()">√ó</button>
        </div>

        <!-- Group Session Banner -->
        <div id="groupBanner" class="group-banner hidden">
            <div class="group-banner-content">
                <span class="group-icon">üë•</span>
                <div class="group-info">
                    <strong id="groupCount">0</strong> people available!
                    <div id="groupNames" class="group-names"></div>
                </div>
                <button class="btn btn-group-join" onclick="joinGroupSession()">Join Session</button>
            </div>
        </div>

        <!-- Availability Status -->
        <div class="status-bar">
            <div id="myStatus" class="status-item">
                <span class="status-dot available"></span>
                <span>Your status: <strong id="myStatusText">Checking...</strong></span>
            </div>
            <div class="status-actions">
                <button id="availableBtn" class="btn btn-available" onclick="setAvailable()">I'm Available</button>
                <button id="unavailableBtn" class="btn btn-unavailable hidden" onclick="setUnavailable()">Go Busy</button>
            </div>
        </div>

        <!-- Team Status -->
        <div id="teamStatus" class="team-status">
            <h3>Team <span id="teamCount" class="team-count"></span></h3>
            <div id="teamList"></div>
        </div>

        <!-- Today's Events -->
        <div class="events-section">
            <h3>Today's Calls</h3>
            <div id="eventsList" class="events-list">
                <p class="loading">Loading calendar...</p>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-section">
            <button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <div id="settingsPanel" class="settings-panel hidden">
                <div class="setting-row">
                    <label>Calendar ICS URL:</label>
                    <input type="text" id="icsUrl" placeholder="Paste your Google Calendar ICS URL">
                </div>
                <div class="setting-row">
                    <label>Your Zoom Link:</label>
                    <input type="text" id="zoomLink" placeholder="https://zoom.us/j/...">
                </div>
                <div class="setting-row">
                    <label>Availability Window:</label>
                    <select id="startHour"></select>
                    <span>to</span>
                    <select id="endHour"></select>
                </div>
                <button class="btn btn-save" onclick="saveSettings()">Save Settings</button>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #333;">
                
                <h4>Manage Team</h4>
                <div class="setting-row">
                    <label>Add Teammate:</label>
                    <input type="text" id="newUserName" placeholder="Name">
                    <button class="btn btn-add" onclick="addUser()">+ Add</button>
                </div>
                <div id="userList" class="user-list"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = '{{ user.id if user else "" }}';
        let pollInterval;
        let availableZoomLinks = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentUser) {
                // No users yet, show add user prompt
                toggleSettings();
                showNotification('üëã Welcome! Add yourself as the first user below.', 'info');
            } else {
                loadSettings();
                loadEvents();
                loadStatus();
                requestNotificationPermission();
                pollInterval = setInterval(() => {
                    loadEvents();
                    loadStatus();
                    checkNotifications();
                }, 30000);
            }
            loadUserList();
        });

        async function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            
            if (Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showNotification('üéØ Notifications enabled!', 'success');
                }
            }
        }

        function sendBrowserNotification(title, body, zoomLink) {
            if (Notification.permission !== 'granted') return;
            
            const notification = new Notification(title, {
                body: body,
                icon: 'üéØ',
                tag: 'roleplay-available',
                requireInteraction: true
            });
            
            notification.onclick = function() {
                window.focus();
                if (zoomLink) {
                    window.open(zoomLink, '_blank');
                }
                notification.close();
            };
        }

        function switchUser() {
            const userId = document.getElementById('userSelect').value;
            window.location.href = '/?user=' + userId;
        }

        async function loadEvents() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/events/${currentUser}`);
                const data = await response.json();
                
                const container = document.getElementById('eventsList');
                
                if (!data.events || data.events.length === 0) {
                    container.innerHTML = '<p class="no-events">No calls scheduled today</p>';
                    return;
                }
                
                container.innerHTML = data.events.map(event => `
                    <div class="event ${event.marked_noshow ? 'noshow' : ''} ${event.needs_noshow_prompt ? 'prompt' : ''}">
                        <div class="event-time">${event.start_time} - ${event.end_time}</div>
                        <div class="event-title">${escapeHtml(event.summary)}</div>
                        ${event.needs_noshow_prompt && !event.marked_noshow ? `
                            <div class="event-actions">
                                <span class="prompt-text">Did they show?</span>
                                <button class="btn btn-showed" onclick="dismissPrompt('${event.uid}')">Yes</button>
                                <button class="btn btn-noshow" onclick="markNoShow('${event.uid}', '${escapeHtml(event.summary)}')">No-Show</button>
                            </div>
                        ` : ''}
                        ${event.marked_noshow ? '<span class="noshow-badge">No-Show</span>' : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading events:', err);
            }
        }

        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const me = data.users.find(u => u.id === currentUser);
                const others = data.users.filter(u => u.id !== currentUser);
                
                // Update team count
                document.getElementById('teamCount').textContent = `(${data.users.length} members)`;
                
                // Update my status
                if (me) {
                    const statusText = document.getElementById('myStatusText');
                    const availBtn = document.getElementById('availableBtn');
                    const unavailBtn = document.getElementById('unavailableBtn');
                    const statusDot = document.querySelector('#myStatus .status-dot');
                    
                    if (me.available) {
                        statusText.textContent = 'Available for roleplay';
                        statusDot.className = 'status-dot available';
                        availBtn.classList.add('hidden');
                        unavailBtn.classList.remove('hidden');
                    } else {
                        statusText.textContent = 'Busy';
                        statusDot.className = 'status-dot busy';
                        availBtn.classList.remove('hidden');
                        unavailBtn.classList.add('hidden');
                    }
                }
                
                // Update group banner
                const groupBanner = document.getElementById('groupBanner');
                const availableOthers = data.available_users.filter(u => u.id !== currentUser);
                availableZoomLinks = availableOthers.map(u => u.zoom_link).filter(Boolean);
                
                if (availableOthers.length >= 1) {
                    groupBanner.classList.remove('hidden');
                    document.getElementById('groupCount').textContent = availableOthers.length + (me?.available ? 1 : 0);
                    document.getElementById('groupNames').textContent = availableOthers.map(u => u.name).join(', ');
                } else {
                    groupBanner.classList.add('hidden');
                }
                
                // Update team list
                const teamList = document.getElementById('teamList');
                if (others.length === 0) {
                    teamList.innerHTML = '<p class="no-team">No teammates yet. Add some in Settings!</p>';
                } else {
                    teamList.innerHTML = others.map(user => `
                        <div class="team-member ${user.available ? 'available' : 'busy'}">
                            <span class="status-dot ${user.available ? 'available' : 'busy'}"></span>
                            <span class="name">${escapeHtml(user.name)}</span>
                            ${user.available && user.zoom_link ? `
                                <a href="${user.zoom_link}" target="_blank" class="btn btn-join">Join</a>
                            ` : ''}
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading status:', err);
            }
        }

        function joinGroupSession() {
            // Join the first available zoom link
            if (availableZoomLinks.length > 0) {
                window.open(availableZoomLinks[0], '_blank');
            } else {
                showNotification('No Zoom links available', 'error');
            }
        }

        async function markNoShow(eventUid, eventSummary) {
            try {
                const response = await fetch('/api/noshow', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser,
                        event_uid: eventUid,
                        event_summary: eventSummary
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Marked as no-show. Team notified!', 'success');
                    loadEvents();
                    loadStatus();
                }
            } catch (err) {
                console.error('Error marking no-show:', err);
            }
        }

        function dismissPrompt(eventUid) {
            const events = document.querySelectorAll('.event');
            events.forEach(el => {
                if (el.querySelector(`[onclick*="${eventUid}"]`)) {
                    el.classList.remove('prompt');
                    const actions = el.querySelector('.event-actions');
                    if (actions) actions.remove();
                }
            });
        }

        async function setAvailable() {
            try {
                const response = await fetch('/api/available', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser})
                });
                const data = await response.json();
                if (data.success) {
                    const msg = data.available_count >= 2 
                        ? `üéØ You're available! ${data.available_count} people ready for group roleplay!`
                        : "üéØ You're now available for roleplay!";
                    showNotification(msg, 'success');
                    loadStatus();
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        async function setUnavailable() {
            try {
                const response = await fetch('/api/unavailable', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser})
                });
                const data = await response.json();
                if (data.success) {
                    loadStatus();
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // User Management
        async function addUser() {
            const nameInput = document.getElementById('newUserName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('Please enter a name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`‚úÖ Added ${name} to the circle!`, 'success');
                    nameInput.value = '';
                    loadUserList();
                    
                    // If this is the first user, switch to them
                    if (!currentUser) {
                        window.location.href = '/?user=' + data.user.id;
                    } else {
                        // Refresh the page to update dropdown
                        window.location.reload();
                    }
                } else {
                    showNotification(data.error || 'Failed to add user', 'error');
                }
            } catch (err) {
                console.error('Error adding user:', err);
            }
        }

        async function removeUser(userId, userName) {
            if (!confirm(`Remove ${userName} from the circle?`)) return;
            
            try {
                const response = await fetch('/api/users', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Removed ${userName}`, 'success');
                    loadUserList();
                    
                    if (userId === currentUser) {
                        window.location.href = '/';
                    } else {
                        window.location.reload();
                    }
                }
            } catch (err) {
                console.error('Error removing user:', err);
            }
        }

        async function loadUserList() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                
                const container = document.getElementById('userList');
                if (data.users.length === 0) {
                    container.innerHTML = '<p class="no-users">No users yet</p>';
                } else {
                    container.innerHTML = data.users.map(u => `
                        <div class="user-item">
                            <span>${escapeHtml(u.name)}</span>
                            <button class="btn btn-remove" onclick="removeUser('${u.id}', '${escapeHtml(u.name)}')">√ó</button>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        let seenNotifications = new Set();
        
        async function checkNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const data = await response.json();
                
                const myNotifications = data.notifications.filter(
                    n => n.to_user_id === currentUser || n.to_telegram_id === '{{ user.telegram_id if user else "" }}'
                );
                
                for (const notif of myNotifications) {
                    const notifKey = notif.timestamp + notif.from_user_id;
                    if (!seenNotifications.has(notifKey)) {
                        seenNotifications.add(notifKey);
                        
                        showNotification(notif.message, 'info');
                        
                        const title = notif.available_count >= 2 
                            ? `üë• ${notif.available_count} people ready!`
                            : `üéØ ${notif.from_name} is available!`;
                        
                        sendBrowserNotification(
                            title,
                            'Tap to join for roleplay',
                            notif.zoom_link
                        );
                        
                        fetch('/api/notifications/mark-delivered', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({timestamp: notif.timestamp})
                        });
                    }
                }
            } catch (err) {
                console.error('Error checking notifications:', err);
            }
        }

        function showNotification(message, type = 'info') {
            const el = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            text.textContent = message;
            el.className = `notification ${type}`;
            el.classList.remove('hidden');
        }

        function hideNotification() {
            document.getElementById('notification').classList.add('hidden');
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        async function loadSettings() {
            const startHour = document.getElementById('startHour');
            const endHour = document.getElementById('endHour');
            
            for (let i = 0; i < 24; i++) {
                const label = i === 0 ? '12 AM' : i < 12 ? `${i} AM` : i === 12 ? '12 PM' : `${i-12} PM`;
                startHour.innerHTML += `<option value="${i}">${label}</option>`;
                endHour.innerHTML += `<option value="${i}">${label}</option>`;
            }
            
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                const user = data.config.users.find(u => u.id === currentUser);
                
                if (user) {
                    document.getElementById('icsUrl').value = user.ics_url || '';
                    document.getElementById('zoomLink').value = user.zoom_link || '';
                    startHour.value = user.availability.start_hour;
                    endHour.value = user.availability.end_hour;
                }
            } catch (err) {
                console.error('Error loading settings:', err);
            }
        }

        async function saveSettings() {
            const settings = {
                user_id: currentUser,
                ics_url: document.getElementById('icsUrl').value,
                zoom_link: document.getElementById('zoomLink').value,
                availability: {
                    start_hour: parseInt(document.getElementById('startHour').value),
                    end_hour: parseInt(document.getElementById('endHour').value)
                }
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Settings saved!', 'success');
                    toggleSettings();
                    loadEvents();
                }
            } catch (err) {
                console.error('Error saving settings:', err);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
