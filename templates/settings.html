{% extends "base.html" %}
{% block title %}Settings - Roleplay Circles{% endblock %}

{% block nav %}
<nav class="nav">
    <div class="nav-inner">
        <a href="/dashboard" class="nav-brand">
            <span>üè†</span> Roleplay Circles
        </a>
        <div class="nav-links">
            <a href="/dashboard" class="btn btn-ghost btn-sm">‚Üê Home</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block body %}
<div class="container page">
    <div class="page-title">Settings</div>
    <div class="page-subtitle">Update your profile and preferences</div>

    <!-- Profile Settings -->
    <div class="card card-flat">
        <div class="card-title mb-2">Profile</div>

        <div class="form-group">
            <label class="form-label">Display Name</label>
            <input type="text" id="settingsDisplayName" class="form-input"
                   value="{{ user.display_name or user.name }}" placeholder="How your team sees you" maxlength="50">
            <div class="text-xs text-muted mt-1">This is how you appear in circles</div>
        </div>

        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" value="{{ user.email }}" disabled
                   style="opacity: 0.5;">
        </div>

        <div class="form-group">
            <label class="form-label">Zoom Link <span style="color:var(--red);">*</span></label>
            <input type="url" id="settingsZoom" class="form-input"
                   value="{{ user.zoom_link or '' }}"
                   placeholder="https://zoom.us/j/..." required>
            <div class="text-xs text-muted mt-1">‚ö†Ô∏è Required ‚Äî you need a Zoom link to go available in circles</div>
        </div>

        <div class="form-group">
            <label class="form-label">Timezone</label>
            <select id="settingsTimezone" class="form-input">
                <option value="America/New_York" {{ 'selected' if user.timezone == 'America/New_York' else '' }}>Eastern (ET)</option>
                <option value="America/Chicago" {{ 'selected' if user.timezone == 'America/Chicago' else '' }}>Central (CT)</option>
                <option value="America/Denver" {{ 'selected' if user.timezone == 'America/Denver' else '' }}>Mountain (MT)</option>
                <option value="America/Los_Angeles" {{ 'selected' if user.timezone == 'America/Los_Angeles' else '' }}>Pacific (PT)</option>
                <option value="America/Phoenix" {{ 'selected' if user.timezone == 'America/Phoenix' else '' }}>Arizona (MST)</option>
                <option value="Pacific/Honolulu" {{ 'selected' if user.timezone == 'Pacific/Honolulu' else '' }}>Hawaii (HST)</option>
                <option value="Europe/London" {{ 'selected' if user.timezone == 'Europe/London' else '' }}>London (GMT/BST)</option>
                <option value="Europe/Berlin" {{ 'selected' if user.timezone == 'Europe/Berlin' else '' }}>Central Europe (CET)</option>
                <option value="Asia/Tokyo" {{ 'selected' if user.timezone == 'Asia/Tokyo' else '' }}>Tokyo (JST)</option>
            </select>
        </div>

        <button onclick="saveProfile()" class="btn btn-primary" id="saveProfileBtn">Save Profile</button>
    </div>

    <!-- Calendar Integration (ICS) -->
    <div class="card card-flat mt-2">
        <div class="card-title mb-2">üìÖ Calendar (ICS URL)</div>
        <p class="text-sm text-muted mb-2">Add your Google Calendar (or any calendar) using its private ICS URL. This lets the app see your schedule for no-show detection.</p>

        <div id="externalCalendarsList" style="min-height: 40px;">
            <div class="text-sm text-muted">Loading...</div>
        </div>

        <div style="margin-top: 12px; padding: 12px; background: var(--bg-hover); border-radius: var(--radius-sm);">
            <div class="text-sm font-bold mb-1">Add Calendar</div>
            <div class="form-group" style="margin-bottom: 8px;">
                <input type="text" id="extCalName" class="form-input" placeholder="Calendar name (e.g. My Google Calendar)">
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <input type="url" id="extCalUrl" class="form-input" placeholder="ICS URL (https://...)">
            </div>
            <button onclick="addExternalCalendar()" class="btn btn-secondary btn-sm" id="addExtCalBtn">Add Calendar</button>
        </div>

        <details style="margin-top: 12px;">
            <summary class="text-xs text-muted" style="cursor:pointer; font-weight:600;">üìñ How to find your Google Calendar ICS URL</summary>
            <div style="padding-top: 8px; font-size: 0.8rem; color: var(--text-muted); line-height: 1.6;">
                <ol style="padding-left: 20px; margin: 0;">
                    <li>Open <a href="https://calendar.google.com/calendar/r/settings" target="_blank" style="color: var(--primary);">Google Calendar Settings</a></li>
                    <li>Click on the calendar you want to add (left sidebar)</li>
                    <li>Scroll down to <strong>"Integrate calendar"</strong></li>
                    <li>Copy the <strong>"Secret address in iCal format"</strong> URL</li>
                    <li>Paste it above ‚Äî it should start with <code>https://calendar.google.com/calendar/ical/</code></li>
                </ol>
                <p style="margin-top: 8px;">‚ö†Ô∏è This is a <em>private</em> read-only URL. It does NOT require Google sign-in ‚Äî it's just a link.</p>
            </div>
        </details>
    </div>

    <!-- Circle-specific settings -->
    {% if memberships %}
    <div class="card card-flat mt-2">
        <div class="card-title mb-2">Availability Hours</div>
        <p class="text-sm text-muted mb-2">Set your available hours for each circle (used to show when you're likely free).</p>

        {% for m in memberships %}
        <div class="mb-2" style="padding: 12px; background: var(--bg-hover); border-radius: var(--radius-sm);">
            <div class="font-bold text-sm mb-1">{{ m.circle_name }}</div>
            <div class="flex gap-1 items-center">
                <select class="form-input circle-start-hour" data-code="{{ m.circle_code }}" style="width: auto;">
                    {% for h in range(0, 24) %}
                    <option value="{{ h }}" {{ 'selected' if m.start_hour == h else '' }}>
                        {{ '%d:00 %s' % (h if h <= 12 else h-12, 'AM' if h < 12 else 'PM') if h != 0 else '12:00 AM' }}
                    </option>
                    {% endfor %}
                </select>
                <span class="text-muted">to</span>
                <select class="form-input circle-end-hour" data-code="{{ m.circle_code }}" style="width: auto;">
                    {% for h in range(0, 24) %}
                    <option value="{{ h }}" {{ 'selected' if m.end_hour == h else '' }}>
                        {{ '%d:00 %s' % (h if h <= 12 else h-12, 'AM' if h < 12 else 'PM') if h != 0 else '12:00 AM' }}
                    </option>
                    {% endfor %}
                </select>
                <button onclick="saveCircleHours(this, '{{ m.circle_code }}')" class="btn btn-secondary btn-sm">Save</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Danger Zone -->
    <div class="card card-flat mt-2">
        <div class="card-title mb-2" style="color: var(--red);">Account</div>
        <a href="/auth/logout" class="btn btn-danger btn-sm">Sign Out</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function saveProfile() {
    const btn = document.getElementById('saveProfileBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        await api('/api/settings', {
            method: 'POST',
            body: {
                display_name: document.getElementById('settingsDisplayName').value.trim(),
                zoom_link: document.getElementById('settingsZoom').value.trim(),
                timezone: document.getElementById('settingsTimezone').value,
            }
        });
        showToast('Settings saved!');
    } catch (err) {
        showToast(err.message, 'error');
    }

    btn.disabled = false;
    btn.textContent = 'Save Profile';
}

// External ICS Calendars
async function loadExternalCalendars() {
    const listEl = document.getElementById('externalCalendarsList');
    try {
        const resp = await fetch('/api/external-calendars');
        const data = await resp.json();

        if (!data.calendars || data.calendars.length === 0) {
            listEl.innerHTML = '<div class="text-sm text-muted">No calendars added yet. Add one below!</div>';
            return;
        }

        let html = '';
        for (const cal of data.calendars) {
            const colorDot = `<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${cal.color};margin-right:8px;vertical-align:middle;"></span>`;
            const checked = cal.selected ? 'checked' : '';
            html += `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-hover);border-radius:var(--radius-sm);margin-bottom:6px;">
                    <label style="display:flex;align-items:center;cursor:pointer;flex:1;">
                        <input type="checkbox" ${checked} onchange="toggleExternalCal(${cal.id}, this.checked)"
                               style="width:18px;height:18px;margin-right:10px;accent-color:var(--primary);">
                        ${colorDot}
                        <span class="text-sm">${cal.name}</span>
                    </label>
                    <button onclick="removeExternalCalendar(${cal.id})" class="btn btn-danger btn-sm" style="padding:2px 8px;font-size:11px;">Remove</button>
                </div>
            `;
        }
        listEl.innerHTML = html;
    } catch (err) {
        listEl.innerHTML = '<div class="text-sm text-muted">Could not load calendars.</div>';
    }
}

async function addExternalCalendar() {
    const btn = document.getElementById('addExtCalBtn');
    const name = document.getElementById('extCalName').value.trim();
    const url = document.getElementById('extCalUrl').value.trim();

    if (!name || !url) {
        showToast('Name and URL are required', 'error');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Adding...';

    try {
        const resp = await fetch('/api/external-calendars', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, ics_url: url })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        showToast('Calendar added!');
        document.getElementById('extCalName').value = '';
        document.getElementById('extCalUrl').value = '';
        loadExternalCalendars();
    } catch (err) {
        showToast(err.message, 'error');
    }

    btn.disabled = false;
    btn.textContent = 'Add Calendar';
}

async function toggleExternalCal(id, selected) {
    try {
        await fetch(`/api/external-calendars/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selected })
        });
    } catch (err) {
        showToast(err.message, 'error');
    }
}

async function removeExternalCalendar(id) {
    if (!confirm('Remove this calendar?')) return;
    try {
        await fetch(`/api/external-calendars/${id}`, { method: 'DELETE' });
        showToast('Calendar removed');
        loadExternalCalendars();
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    loadExternalCalendars();
});

async function saveCircleHours(btn, code) {
    const row = btn.closest('.mb-2');
    const startHour = parseInt(row.querySelector('.circle-start-hour').value);
    const endHour = parseInt(row.querySelector('.circle-end-hour').value);

    try {
        await api('/api/settings', {
            method: 'POST',
            body: {
                circle_code: code,
                start_hour: startHour,
                end_hour: endHour,
            }
        });
        showToast('Hours updated!');
    } catch (err) {
        showToast(err.message, 'error');
    }
}
</script>
{% endblock %}
